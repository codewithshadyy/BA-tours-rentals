
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>M-Pesa Payment</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="payment-page">
    <h2>Complete Payment via M-Pesa</h2>
    <div id="payment-summary"></div>

    <form id="payment-form" class="payment-form">
      <label>M-Pesa Phone Number:
        <input id="mpesa-number" type="tel" placeholder="e.g. 0712345678" required>
      </label>
      <button type="submit">Pay with M-Pesa</button>
    </form>

    <p id="pay-msg"></p>
  </div>

  
  <script src="app.js"></script>
<script>
  const booking = JSON.parse(localStorage.getItem('pendingBooking'));
  const summaryEl = document.getElementById('payment-summary');
  const msg = document.getElementById('pay-msg');
  const mpesaInput = document.getElementById('mpesa-number');

  async function loadPropertyAndShowSummary() {
    if (!booking) {
      summaryEl.innerHTML = '<p>No booking info found. Go back to dashboard.</p>';
      return;
    }

    try {
      // Fetch property details from backend
      const res = await fetch(`${API}/client/properties?id=${booking.itemId}`, { headers: apiHeaders() });
      const data = await res.json();
      const property = Array.isArray(data) ? data[0] : data;

      const basePrice = property?.price || 0;
      const total = (basePrice * booking.adults) + (basePrice * 0.5 * booking.children);

      booking.total = total; // attach to booking object for final submission
      booking.price = basePrice;

      summaryEl.innerHTML = `
        <div class="summary-card">
          <h3>${property.title || 'Property Selected'}</h3>
          <p><strong>Price per Adult:</strong> KSh ${basePrice}</p>
          <p><strong>Price per Child:</strong> KSh ${basePrice * 0.5}</p>
          <p><strong>Adults:</strong> ${booking.adults}</p>
          <p><strong>Children:</strong> ${booking.children}</p>
          <p><strong>Total:</strong> <span class="price">KSh ${total}</span></p>
          <p><strong>From:</strong> ${new Date(booking.startDate).toLocaleDateString()}</p>
          <p><strong>To:</strong> ${new Date(booking.endDate).toLocaleDateString()}</p>
        </div>
      `;
    } catch (err) {
      console.error(err);
      summaryEl.innerHTML = '<p>Error loading property price.</p>';
    }
  }

  // Call on load
  loadPropertyAndShowSummary();

  // Handle fake payment
  document.getElementById('payment-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.textContent = 'Processing M-Pesa payment...';
    msg.style.color = '#ffb74d';

    setTimeout(async ()=>{
      msg.textContent = 'Payment successful!';
      msg.style.color = '#4caf50';

      const bookingWithPayment = {
        ...booking,
        phone: mpesaInput.value.trim(),
        paymentMethod: 'M-Pesa',
        paymentStatus: 'Paid'
      };

      try {
        const res = await fetch(`${API}/client/book`, {
          method: 'POST',
          headers: apiHeaders(),
          body: JSON.stringify(bookingWithPayment)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Booking failed');
        msg.textContent = 'Booking confirmed! Redirecting...';
        setTimeout(()=> location.href = './client_dashboard.html', 2000);
      } catch (err) {
        
        msg.textContent = 'Booking error. Please try again.';
        msg.style.color = 'red';
      }
    }, 2000);
  });
</script>

  
     

</body>
</html>
